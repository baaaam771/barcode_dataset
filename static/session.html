<!DOCTYPE html>
<html>
<head> 
    <meta charset="utf-8"> 
    <title>Performance Test</title> 
    <style type="text/css">
        table, th, td {
          border: 1px solid black;
          text-align: center;
        }
        
        .false{
          color: red;
        }
    </style>
</head>
<body>
    <div id="session">
        <p>Session: <span id="sessionId"></span></p>
        <button type="button" onclick='startSession()'>Start Session</button>
        <p>Progress: <span id="sessionProgress"></span></p>
        <button type="button" onclick='getStatistics()'>Get Statistics</button>
        <div id="statistics">
        </div>
    </div>
<script>
    var started = false;
    get_session_id();
    
    function get_session_id(){
        sessionId = getUrlParam("id");
        document.getElementById("sessionId").innerText = sessionId;
        return sessionId;
    }
        
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }
    
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    function startSession(){
        if (started==true) {
            return;
        }
        started = true;
        var session_id = document.getElementById("sessionId").innerText;
        var url = "session/"+session_id+"/start";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);

        xhr.onreadystatechange = async function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                checkProgress();
            }
        }
        xhr.send();
    }
    
    function checkProgress(){
        var session_id = document.getElementById("sessionId").innerText;
        var url = "session/"+session_id+"/progress";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);

        xhr.onreadystatechange = async function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                var progress = xhr.responseText;
                
                if (progress.split("/")[0]!=progress.split("/")[1]){
                    document.getElementById("sessionProgress").innerText = progress;
                    await sleep(1000);
                    checkProgress();
                }else{
                    document.getElementById("sessionProgress").innerText = "Done!";
                }
                
            }
        }
        xhr.send();
    }
    
    function getStatistics(){
        var session_id = document.getElementById("sessionId").innerText;
        var url = "session/"+session_id+"/statistics";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);

        xhr.onreadystatechange = async function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                var data = JSON.parse(xhr.responseText);
                var overview = document.createElement("pre");
                var content = "Presion:"+ data["precision"];
                content = content + "\n" + "Accuracy: " + data["accuracy"];
                content = content + "\nTotal: " + data["total"];
                content = content + "\nUndetected: " + data["undetected"];
                content = content + "\nWrongly detected: " + data["wrong_detected"];
                
                overview.innerHTML = content;
                var statisticsContainer = document.getElementById("statistics");
                statisticsContainer.append(overview);
                statisticsContainer.append(createTable(data));
                
            }
        }
        xhr.send();
        
    }
    
    function createTable(data){
        var session_id = document.getElementById("sessionId").innerText;
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var tbody = document.createElement('tbody');

        table.appendChild(thead);
        table.appendChild(tbody);
        
        let row_1 = document.createElement('tr');
        let heading_0 = document.createElement('th');
        heading_0.innerHTML = "No.";
        let heading_1 = document.createElement('th');
        heading_1.innerHTML = "Filename";
        let heading_2 = document.createElement('th');
        heading_2.innerHTML = "Detected Text";
        let heading_3 = document.createElement('th');
        heading_3.innerHTML = "Ground Truth";
        let heading_4 = document.createElement('th');
        heading_4.innerHTML = "Correct";

        row_1.appendChild(heading_0);
        row_1.appendChild(heading_1);
        row_1.appendChild(heading_2);
        row_1.appendChild(heading_3);
        row_1.appendChild(heading_4);
        thead.appendChild(row_1);
        
        
        var imgResults = data["img_results"];
        var index = 0;
        for (let key in imgResults) {
            index = index+1;
            var imgResult = imgResults[key];
            var groundTruth = imgResult["ground_truth"];
            var results = imgResult["results"];
            var barcodeText = "";
            for (var j=0;j<results.length;j++){
                var result = results[j];
                if (j>0){
                    barcodeText = barcodeText + ", "
                }
                barcodeText = barcodeText + result["barcodeText"];
            }
            // Creating and adding data to second row of the table
            var row = document.createElement('tr');
            var c0 = document.createElement('td');
            c0.innerHTML = index;
            var c1 = document.createElement('td');
            //c1.innerHTML = key;
            var a = document.createElement("a");
            a.href = "/session/"+ session_id +"/image/" + key;
            a.target = "_blank";
            a.innerText = key;
            c1.append(a);
            var c2 = document.createElement('td');
            c2.innerHTML = barcodeText;
            var c3 = document.createElement('td');
            c3.innerHTML = groundTruth;
            
            var failed = imgResult["failed"];
            var correct = "true";
            if (failed == true){
                correct = "<span class=\"false\">false</span>";
            }

            var c4 = document.createElement('td');
            c4.innerHTML = correct;
            row.appendChild(c0);
            row.appendChild(c1);
            row.appendChild(c2);
            row.appendChild(c3);
            row.appendChild(c4);
            tbody.appendChild(row);
           
        }
        return table;
    }
</script>


</body>
</html>