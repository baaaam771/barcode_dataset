<!DOCTYPE html>
<html>
<head> 
    <meta charset="utf-8"> 
    <title>Performance Test</title> 
    <style type="text/css">
        table, th, td {
          border: 1px solid black;
          text-align: center;
          max-width: 200px;
          overflow: auto;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.1.2/dist/echarts.min.js"></script>
    
</head>
<body>
    <div id="session">
        <p>Session: <span id="sessionId"></span></p>
        <label>Barcodes level:
        <input type="checkbox" id="barcodes-level" name="barcodes-level" value="barcodes-level"></label>
        </br>
        <label>In categories:
        <input type="checkbox" id="in-categories" name="in-categories" value="in-categories"></label>
        </br>
        <button type="button" onclick='getDataAndDrawChartAndTable()'>Draw Comparison Chart and Table</button><br/>
        <button type="button" onclick='getComparisonStatistics()'>Get Comparison Statistics</button><br/>
        <div id="engines">
        Engines: 
        </div>
        <div id="overview-table"></div>
        <div id="charts" style="display:none;"></div>

        <div id="statistics">
            <a href="#" onclick="download_table_as_csv();" id=
            "csv" style="display:none;">Download as CSV</a>
            <div id="filter"></div>
            <div id="comparisonTable"></div>
        </div>
    </div>
<script>
    get_session_id();
    loadEngines();
    
    function inCategories(){
        return document.getElementById("in-categories").checked;
    }
    
    function loadEngines() {
        var url = "engines";
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);

        xhr.onreadystatechange = function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                engines = JSON.parse(xhr.responseText)["engines"];
                var engines_select = document.getElementById("engine");
                var container = document.getElementById("engines");
                for (var i=0;i<engines.length;i++) {
                    var engine = engines[i];
                    var lbl = document.createElement("label");
                    var chk = document.createElement("input");
                    chk.type = "checkbox";
                    chk.checked = true;
                    chk.value = engine;
                    lbl.append(chk);
                    lbl.append(engine);
                    container.append(lbl);
                }
            }
        }
        xhr.send();
    }
    
    function getEnabledEngines() {
        engines=[];
        var container = document.getElementById("engines");
        var chks = container.getElementsByTagName("input");
        for (var i=0;i<chks.length;i++) {
            chk = chks[i];
            if (chk.checked == true) {
                engines.push(chk.value);
            }
        }
        return engines;
    }
    
    function getDataAndDrawChartAndTable(){
        var session_id = document.getElementById("sessionId").innerText;
        var url = "session/"+session_id+"/comparison/"
        var pay_load = {"engines":getEnabledEngines()};
        if (inCategories()){
            pay_load["in_category"] = true;
        }
        var xhr = new XMLHttpRequest();
        xhr.open('POST', url);
        xhr.onreadystatechange = async function(){
            if(xhr.readyState === 4){
                console.log(xhr.status);
                console.log(xhr.responseText);
                var data = JSON.parse(xhr.responseText);
                var data_in_categories = {};
                if (inCategories()){
                    var chartsContainer = document.getElementById("charts");
                    chartsContainer.innerHTML = "";
                    
                    for (var category in data) {
                        var head = document.createElement("h2");
                        head.innerText = category;
                        chartsContainer.append(head);
                        var engine_data = get_engines_data(data[category]);
                        data_in_categories[category]=engine_data;
                        drawChart(engine_data,false);
                    }
                } else{
                    var engine_data = get_engines_data(data);
                    data_in_categories["Result"] = engine_data;
                    drawChart(engine_data,true);
                }
                console.log(data_in_categories);
                createOverviewTable(data_in_categories);
                
            }
        }
        var json = JSON.stringify(pay_load);
        xhr.send(json);
    }
    
    function drawChart(engine_data, clear){
        // based on prepared DOM, initialize echarts instance
        var chartsContainer = document.getElementById("charts");
        chartsContainer.style.display = "block";
        if (clear == true){
            chartsContainer.innerHTML = "";
        }
        var engines = [];
        for (var engine in engine_data) {
            engines.push(engine);
        }
        var categories = ["accuracy","precision","f1score","time_elapsed","average_time"];
        for (var i=0;i<categories.length;i++){
            var category = categories[i];
            var chartClass = category.replace("_","");
            var chartsContainer = document.getElementById("charts");
            var chart = document.createElement("div");
            chart.style.width = "800px";
            chart.style.height = "400px";
            chart.className = chartClass;
            chartsContainer.append(chart);
            var myChart = echarts.init(chart);
            option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: engines
                },
                toolbox: {
                    show: true,
                    orient: 'vertical',
                    left: 'right',
                    top: 'center',
                    feature: {
                        mark: {show: true},
                        dataView: {show: true, readOnly: false},
                        magicType: {show: true, type: ['line', 'bar', 'stack', 'tiled']},
                        restore: {show: true},
                        saveAsImage: {show: true}
                    }
                },
                xAxis: [
                    {
                        type: 'category',
                        axisTick: {show: false},
                        data: [category]
                    }
                ],
                yAxis: [
                    {
                        type: 'value'
                    }
                ],
                series: get_series(engines, engine_data, category)
            };
            // use configuration item and data specified to show chart
            myChart.setOption(option);
        }
    }
    
    function createOverviewTable(data_in_categories) {
        var container = document.getElementById("overview-table");
        container.innerHTML="";
        var table_categories = ["accuracy","precision","f1score","time_elapsed","average_time"];
        for (var i=0;i<table_categories.length;i++) {
            var h2 = document.createElement("h2");
            h2.innerText = table_categories[i];
            var table = createTableOfOneCategory(table_categories[i],data_in_categories);
            container.append(h2);
            container.append(table);
        } 
    }
    
    function createTableOfOneCategory(table_category, data_in_categories){
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var tbody = document.createElement('tbody');

        table.appendChild(thead);
        table.appendChild(tbody);
        
        var headers = ["Engine"];
         for (var category in data_in_categories) {
            headers.push(category);
        }
        let row_1 = document.createElement('tr');
        for (var i =0;i<headers.length;i++){
            let heading = document.createElement('th');
            heading.innerHTML = headers[i];
            row_1.appendChild(heading);
        }
        thead.appendChild(row_1);
        
        var engines = [];
        var engine_data = data_in_categories[headers[1]];
        for (var engine in engine_data) {
            engines.push(engine);
        }
        
        for (var i=0;i<engines.length;i++) {
            var engine = engines[i];
            var row = document.createElement('tr');
            var data = [];
            data.push(engine);
            for (var category in data_in_categories) {
                var engines_data = data_in_categories[category];
                var engine_data = engines_data[engine];
                data.push(engine_data[table_category])
            }
            
            for (var j=0;j<data.length;j++) {
                var c = document.createElement('td');
                c.innerHTML = data[j];
                row.appendChild(c);
            }
            
            tbody.appendChild(row);
        }
       return table;
    }
    
    function get_engines_data(data){
        var barcodesLevel = document.getElementById("barcodes-level").checked;
        affix = "";
        if (barcodesLevel==true){
            affix = "_barcodes";
        }
        var engine_data = {};
        for (var key in data) {
            var one_engine = data[key];
            one_engine["accuracy"] = (100*one_engine["accuracy"+affix]).toFixed(2);
            one_engine["precision"] = (100*one_engine["precision"+affix]).toFixed(2);
            one_engine["f1score"] = (100*one_engine["f1score"+affix]).toFixed(2);
            one_engine["time_elapsed"] = one_engine["time_elapsed"].toFixed(2);
            one_engine["average_time"] = one_engine["average_time"].toFixed(2);
            engine_data[key] = one_engine;
        }
        return engine_data;
    }
    
    function get_series(engines, engine_data, category) {
        series = []
        showLabel = true;
        if (engines.length>4) {
            showLabel = false;
        }
        var labelOption = {
            show: showLabel,
            formatter: '{c}  {name|{a}}',
            fontSize: 12,
            rich: {
                name: {
                }
            }
        };
        for (var i=0;i<engines.length;i++) {
            engine = engines[i];
            serie = {
                        name: engine, 
                        type: 'bar', 
                        barGap: 0, 
                        label: labelOption, 
                        emphasis: {
                            focus: 'series'
                        },
                        data: [engine_data[engine][category]]
                    }
            series.push(serie);
        }
        return series
    }
    
    function get_session_id(){
        sessionId = getUrlParam("id");
        document.getElementById("sessionId").innerText = sessionId;
        return sessionId;
    }
        
    function getUrlParam(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]); return null;
    }
    
    function getComparisonStatistics(){
        var session_id = document.getElementById("sessionId").innerText;
        var url = "session/"+session_id+"/complete-comparison/"
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url);
        xhr.onreadystatechange = async function(){
            if(xhr.readyState === 4){
                var data = JSON.parse(xhr.responseText);
                var comparisonTable = document.getElementById("comparisonTable");
                comparisonTable.innerHTML = "";
                comparisonTable.append(createComparisonTable(data));
                var csv_button = document.getElementById("csv");
                csv_button.style.display = "inline";
            }
        }
        xhr.send();
    }
    
    function createComparisonTable(comparisonData){
        var session_id = document.getElementById("sessionId").innerText;
        var table = document.createElement('table');
        var thead = document.createElement('thead');
        var tbody = document.createElement('tbody');

        table.appendChild(thead);
        table.appendChild(tbody);
        
        var headers = ["No.","Filename","Detected", "Undetected"];
        let row_1 = document.createElement('tr');
        for (var i =0;i<headers.length;i++){
            let heading = document.createElement('th');
            heading.innerHTML = headers[i];
            row_1.appendChild(heading);
        }
        thead.appendChild(row_1);
        var engines = [];
        for (var key in comparisonData) {
            if (key!="mergedDetails") {
                engines.push(key);
            }
        }
        var mergedDetails = comparisonData["mergedDetails"];
        var index = 0;
        for (var filename in mergedDetails) {
            index = index+1;
            var details = mergedDetails[filename];
            var row = document.createElement('tr');
            var data = [];
            data.push(index);
            var a = document.createElement("a");
            a.href = "/reader.html?id="+ session_id +"&filename=" + filename;
            a.target = "_blank";
            a.innerText = filename;
            data.push(a.outerHTML)
            
            var detected = details["detected"];
            var undetected = details["undetected"];
            var detected_engines = detected.join();
            var undetected_engines = undetected.join();
            data.push(detected_engines)
            data.push(undetected_engines)
            
            for (var i=0;i<data.length;i++) {
                var c = document.createElement('td');
                c.innerHTML = data[i];
                row.appendChild(c);
            }
            
            tbody.appendChild(row);
        }
        appendFilter(engines);

       return table;
    }
    
    function download_table_as_csv(separator = ',') {
        // Select rows from table_id
        var rows = document.getElementsByTagName('tr');
        // Construct csv
        var csv = [];
        for (var i = 0; i < rows.length; i++) {
            var row = [], cols = rows[i].querySelectorAll('td, th');
            for (var j = 0; j < cols.length; j++) {
                // Clean innertext to remove multiple spaces and jumpline (break csv)
                var data = cols[j].innerText.replace(/(\r\n|\n|\r)/gm, '').replace(/(\s\s)/gm, ' ')
                // Escape double-quote with double-double-quote (see https://stackoverflow.com/questions/17808511/properly-escape-a-double-quote-in-csv)
                data = data.replace(/"/g, '""');
                // Push escaped string
                row.push('"' + data + '"');
            }
            csv.push(row.join(separator));
        }
        var csv_string = csv.join('\n');
        // Download it
        
        
        var filename = document.getElementById("sessionId").innerText + "-" + get_engine()+ '.csv';
        var link = document.createElement('a');
        link.style.display = 'none';
        link.setAttribute('target', '_blank');
        link.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv_string));
        link.setAttribute('download', filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function appendFilter(engines){
        var filterContainer = document.getElementById("filter");
        filterContainer.innerHTML = "";
        var categories = ["Detected","Undetected"];
        for (var i = 0; i < categories.length; i++) {
            var category = categories[i];
            var container = document.createElement("div");
            container.id = category;
            container.append(category + ": ")
            for (var j = 0; j < engines.length; j++) {
                var engine = engines[j];
                var lbl = document.createElement("label");
                var chk = document.createElement("input");
                chk.type = "checkbox";
                chk.value = engine;
                lbl.append(chk);
                lbl.append(engine);
                container.append(lbl);
            }
            filterContainer.append(container);
        }
        var btn = document.createElement("button");
        btn.type = "button";
        btn.innerText = "Filter";
        btn.onclick = filterResults;
        filterContainer.append(btn);
    }
    
    function filterResults(){
        var categories = ["Detected","Undetected"];
        var detected_conditions = {};
        var undetected_conditions = {};
        for (var i = 0; i < categories.length; i++) {
            var category = categories[i];
            var container = document.getElementById(category);
            var chks = container.getElementsByTagName("input");
            for (var j = 0; j < chks.length; j++) {
                var chk = chks[j];
                if (i==0){
                    detected_conditions[chk.value] = chk.checked;
                } else
                {
                    undetected_conditions[chk.value] = chk.checked;
                }
            }
        }
        var rows = document.getElementsByTagName("tr");
        var rowsToHide = [];
        for (var i = 1; i < rows.length; i++) {
            var row = rows[i];
            row.style.display = "";
            var detected_engines = row.cells[2].textContent.split(",");
            var undetected_engines = row.cells[3].textContent.split(",");
            
            var shouldHide = false;
            
            for (let engine in detected_conditions) {
                if (detected_conditions[engine] == true) {
                    if (detected_engines.indexOf(engine) == -1){
                        rowsToHide.push(row);
                        shouldHide = true;
                        break
                    }
                }
            }
            
            if (shouldHide){
                continue
            }
            for (let engine in undetected_conditions) {
                if (undetected_conditions[engine] == true) {
                    if (undetected_engines.indexOf(engine) == -1){
                        rowsToHide.push(row);
                        shouldHide = true;
                    }
                }
            }

        }

        for (var i = 0; i < rowsToHide.length; i++) {
            var row = rowsToHide[i];
            row.style.display = "none";
        }
    }
</script>


</body>
</html>